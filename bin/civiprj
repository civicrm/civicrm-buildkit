#!/bin/bash
set -e

###############################################################################
## Bootstrap

## Determine the absolute path of the directory with the file
## usage: absdirname <file-path>
function absdirname() {
  pushd $(dirname $0) >> /dev/null
    pwd
  popd >> /dev/null
}

BINDIR=$(absdirname "$0")
PRJDIR=$(dirname "$BINDIR")
TMPDIR="$PRJDIR/app/tmp"
BLDDIR="$PRJDIR/build"

if [ ! -e "$TMPDIR" ]; then
  mkdir -p "$TMPDIR"
fi

source "$PRJDIR/src/civiprj.lib.sh"

## Make sure bundled utilities are available, regardless of local config
export PATH="$BINDIR:$PATH"

###############################################################################
## Display usage message
function civiprj_usage() {
  APP=$(basename "$0")
  cat <<EOT
Usage: $APP create <name> [options]
  <name>              The name of the sub-directory to build
  --type <type>       The name of the download/install scripts. (If omitted, assume <name>) [Optional]
  --url <url>         The public URL of the site
  --title <title>     The title of the site
  --civi-ver <ver>    The branch or tag of CiviCRM desired (master, 4.4, 4.3, 4.3.0, etc) [Optional]
  --cms-ver <ver>     The release of the CMS desired [Optional]
  --force             If the source tree or DB already exists, destroy and recreate
  --force-download    If the source tree already exists, destroy and recreate
  --force-install     If the DB/config already exists, destroy and recreate
  --mysql-ram-server  Setup and run a separate MySQL instance on a RAM disk

Usage: $APP reset <name> [options]
  <name>              The name of the sub-directory to build
  --cms <sql-file>    The path to a SQL backup of the CMS DB [Optional]
  --no-cms            Skip resetting the CMS DB [Optional]
  --civi <sql-file>   The path to a SQL backup of the CiviCRM DB [Optional]
  --no-civi           Skip resetting the CiviCRM DB [Optional]

Usage: $APP run-tests [name] [options]
  [name]              The name of the project to use.
EOT

  exit 99;
}

## Run an external script (based on the site-type)
function civiprj_run() {
  MAIN_SCRIPT="${SITE_CONFIG_DIR}/$1.sh"
  [ ! -f "$MAIN_SCRIPT" ] && echo "ERROR: Missing main script ($MAIN_SCRIPT)" && exit 98

  echo "[[Execute $MAIN_SCRIPT]]"
  set -ex
  source "$MAIN_SCRIPT"
  set +ex
}

###############################################################################
## Parse options
source "$PRJDIR/src/civiprj.defaults.sh"

LOCAL_CONFIG_FILE_PATH="$PRJDIR/config/civiprj.config.sh"
if [ -e $LOCAL_CONFIG_FILE_PATH ]; then
  source $LOCAL_CONFIG_FILE_PATH
fi

ACTION="$1"
[ -z "$ACTION" ] && civiprj_usage
shift

SITE_NAME="$1"
shift

if [ -f "${BLDDIR}/${SITE_NAME}.sh" ]; then
  echo "[[Load saved options from ${BLDDIR}/${SITE_NAME}.sh]]"
  source "${BLDDIR}/${SITE_NAME}.sh"
fi

while [ -n "$1" ] ; do
  OPTION="$1"
  shift

  case "$OPTION" in
    -h|--help|-?)
      civiprj_usage
      ;;

    --civi)
      CIVI_SQL="$1"
      shift
      ;;

    --civi-ver)
      CIVI_VERSION="$1"
      shift
      ;;

    --cms)
      CMS_SQL="$1"
      shift
      ;;

    --cms-ver)
      CMS_VERSION="$1"
      shift
      ;;

    --force)
      FORCE_DOWNLOAD=1
      FORCE_INSTALL=1
      ;;

    --force-download)
      FORCE_DOWNLOAD=1
      ;;

    --force-install)
      FORCE_INSTALL=1
      ;;

    --mysql-ram-server)
      MYSQL_RAM_SERVER=1
      ;;

    --no-civi)
      CIVI_SQL_SKIP=1
      ;;

    --no-cms)
      CMS_SQL_SKIP=1
      ;;

    --title)
      CMS_TITLE="$1"
      shift
      ;;

    --type)
      SITE_TYPE="$1"
      shift
      ;;

    --url)
      CMS_URL="$1"
      shift
      ;;

    *)
      echo "Unrecognized option: $OPTION"
      civiprj_usage
      ;;
  esac
done

source "$PRJDIR/src/civiprj.compute-defaults.sh"

###############################################################################
## Main

case "$ACTION" in
  create)
    civiprj_create
    ;;

  reset)
    echo reset
    ;;

  run-tests)
    civiprj_run_tests
    ;;

  *)
    echo "Unrecognized action: $ACTION"
    civiprj_usage
    ;;
esac
