#!/usr/bin/env bash
set -ex

loco-mysql-select

mysql_version=$(mysql --no-defaults --version)
mysql_current="$LOCO_SVC_VAR/current"
mysql_target="$LOCO_SVC_VAR/$MYSQL_ID"
mysql_cnf="$mysql_target/conf/my.cnf"
mysql_datadir="$mysql_target/data"

mkdir -p "$mysql_current"/{conf,log,tmp,run}

php "$LOCO_CFG/mysql/conf/my.cnf.php" > "$mysql_cnf"
php "$LOCO_CFG/mysql-common/my.cnf.php" > "$mysql_current/conf/common-my.cnf"

## MySQL v5.7
if echo "$mysql_version" | grep 'Distrib 5.7' -q; then
  mysqld --defaults-file="$mysql_cnf" --initialize-insecure --explicit_defaults_for_timestamp --datadir="$mysql_datadir"

elif echo "$mysql_version" | grep 'Ver [89].' -q; then
  #mysqld --no-defaults --initialize-insecure --explicit_defaults_for_timestamp --datadir="$mysql_datadir"
  mysqld --defaults-file="$mysql_cnf" --initialize-insecure --explicit_defaults_for_timestamp --datadir="$mysql_datadir"

## MariaDB
elif echo "$mysql_version" | grep 'MariaDB' -q; then
  mysql_bin=$(dirname $(which mysqld))
  mysql_base=$(dirname "$mysql_bin")
  pushd "$mysql_base"
    set -ex
      mysql_install_db --datadir="$mysql_datadir" --defaults-file="$mysql_cnf" --skip-name-resolve --auth-root-authentication-method=normal
    set +ex
  popd

## Older MySQL?
else
  mysql_bin=$(dirname $(which mysqld))
  mysql_base=$(dirname "$mysql_bin")
  pushd "$mysql_base"
    set -ex
      mysql_install_db --datadir="$mysql_datadir" --defaults-file="$mysql_cnf" --skip-name-resolve
    set +ex
  popd
fi
